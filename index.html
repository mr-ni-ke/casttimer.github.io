<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Timer App</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <div id="g_id_onload"
       data-client_id="619365294529-8hf03vg6qev82netv9ot7a80e8kic98q.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="true">
  </div>
  <div id="g_id_signin"></div>

  <div class="container" style="display:none;" id="app">
    <p>Welcome, <span id="userName"></span> (<span id="userLang"></span>)</p>

    <label>You are MC or CC today?</label>
    <select id="modeSelect">
      <option value="MC">MC</option>
      <option value="CC">CC</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>

    <p id="timer">00:00:00</p>
    <p id="savedTime"></p>
  </div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec';

  let startTime, interval;

  function handleCredentialResponse(response) {
    const id_token = response.credential;
    fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id_token })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert('Access denied');
        return;
      }
      const ud = data.userData;
      document.getElementById('userName').textContent = ud.name;
      document.getElementById('userLang').textContent = ud.language;
      document.getElementById('app').style.display = 'block';
      initTimer(ud);
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  }

  function initTimer({language, name}) {
    const timerEl = document.getElementById('timer');
    const savedEl = document.getElementById('savedTime');
    document.getElementById('startBtn').onclick = () => {
      startTime = Date.now();
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      timerEl.classList.add('active');
      savedEl.textContent = '';
      interval = setInterval(() => {
        const diff = Date.now() - startTime;
        timerEl.textContent = new Date(diff).toISOString().substr(11, 8);
      }, 1000);
    };
    document.getElementById('stopBtn').onclick = () => {
      clearInterval(interval);
      const stopTime = Date.now();
      const duration = ((stopTime - startTime) / 1000).toFixed(2);

      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action: 'save',
          start: new Date(startTime).toISOString(),
          stop: new Date(stopTime).toISOString(),
          language,
          name,
          duration: parseFloat(duration),
          mode: document.getElementById('modeSelect').value
        })
      });

      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      timerEl.textContent = '00:00:00';
      timerEl.classList.remove('active');
      savedEl.textContent = `Saved: ${new Date(stopTime - startTime).toISOString().substr(11,8)}`;
    };
  }
</script>

</body>
</html>
