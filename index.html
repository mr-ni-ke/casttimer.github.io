<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Cast Timer</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial; padding: 2em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="g_id_onload"
       data-client_id="619365294529-8hf03vg6qev82netv9ot7a80e8kic98q.apps.googleusercontent.com"
       data-context="signin"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin" data-type="standard"></div>

  <div id="app" class="hidden">
    <h2 id="welcome"></h2>
    <p>Language: <span id="lang"></span></p>

    <select id="taskSelect">
      <option value="MC">MC</option>
      <option value="CC">CC</option>
    </select>

    <button id="startBtn">Start</button>
    <button id="stopBtn" class="hidden">Stop</button>
    <p id="timer">00:00:00</p>
  </div>

  <script>
    let userData = {};
    let startTime = null;
    let timerInterval = null;

    function handleCredentialResponse(response) {
      const id_token = response.credential;

      fetch('https://script.google.com/macros/s/AKfycbwYEOZevDPfUdKgx2bLUEZ5PtLqtg-fMdcJ0jgfmnFUHE2jLpkbTkQA7OLQVe4tRjJntA/exec?endpoint=verify' + encodeURIComponent(window.location.origin), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token })
      })
      .then(res => res.json())
      .then(data => {
        if (!data || !data.name) {
          alert('Access denied');
          return;
        }
        userData = data;
        document.getElementById('welcome').textContent = `Welcome, ${data.name}`;
        document.getElementById('lang').textContent = data.lang;
        document.querySelector('.g_id_signin').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
      })
      .catch(err => {
        console.error('Verification failed', err);
      });
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      startTime = new Date();
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('stopBtn').classList.remove('hidden');
      timerInterval = setInterval(() => {
        const now = new Date();
        const diff = new Date(now - startTime);
        const h = String(diff.getUTCHours()).padStart(2, '0');
        const m = String(diff.getUTCMinutes()).padStart(2, '0');
        const s = String(diff.getUTCSeconds()).padStart(2, '0');
        document.getElementById('timer').textContent = `${h}:${m}:${s}`;
      }, 1000);
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      const endTime = new Date();
      clearInterval(timerInterval);

      const durationMs = endTime - startTime;
      const durationSec = Math.floor(durationMs / 1000);

      const payload = {
        name: userData.name,
        lang: userData.lang,
        task: document.getElementById('taskSelect').value,
        start: startTime.toISOString(),
        end: endTime.toISOString(),
        duration: durationSec
      };

      fetch('https://script.google.com/macros/s/AKfycbwYEOZevDPfUdKgx2bLUEZ5PtLqtg-fMdcJ0jgfmnFUHE2jLpkbTkQA7OLQVe4tRjJntA/exec?endpoint=log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        alert('Saved!');
      }).catch(err => {
        alert('Save failed');
        console.error(err);
      });

      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
    });
  </script>
</body>
</html>
