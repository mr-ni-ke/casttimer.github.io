<!DOCTYPE html>
<html>
<head>
  <title>Timer Page</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #info, #controls { display: none; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="g_id_onload"
       data-client_id="619365294529-8hf03vg6qev82netv9ot7a80e8kic98q.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <div id="info"></div>

  <div id="controls">
    <label>
      <input type="radio" name="mode" value="MC" checked /> MC
    </label>
    <label>
      <input type="radio" name="mode" value="CC" /> CC
    </label>
    <br><br>
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <p>Elapsed time: <span id="timer">0</span> sec</p>
  </div>

  <script>
    let idToken = null;
    let startTime = null;
    let timerInterval = null;
    let emailMap = {
      "example1@gmail.com": { name: "User1", language: "EN" },
      "example2@gmail.com": { name: "User2", language: "RU" }
    };
    let currentUser = {};

    function handleCredentialResponse(response) {
      idToken = response.credential;
      fetch('https://script.google.com/macros/s/AKfycbwYEOZevDPfUdKgx2bLUEZ5PtLqtg-fMdcJ0jgfmnFUHE2jLpkbTkQA7OLQVe4tRjJntA/exec', {
        method: 'POST',
        body: JSON.stringify({ id_token: idToken }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(r => r.json())
      .then(user => {
        if (!user.email || !emailMap[user.email]) {
          document.getElementById("info").innerText = "Access denied.";
          return;
        }
        currentUser = {
          ...emailMap[user.email],
          email: user.email
        };
        document.getElementById("info").innerText =
          `Name: ${currentUser.name}, Language: ${currentUser.language}`;
        document.getElementById("info").style.display = "block";
        document.getElementById("controls").style.display = "block";
      });
    }

    document.getElementById("startBtn").onclick = () => {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").innerText = elapsed;
      }, 1000);
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
      clearInterval(timerInterval);
      const stopTime = Date.now();
      const duration = Math.floor((stopTime - startTime) / 1000);
      const mode = document.querySelector('input[name="mode"]:checked').value;

      fetch('https://script.google.com/macros/s/AKfycbwYEOZevDPfUdKgx2bLUEZ5PtLqtg-fMdcJ0jgfmnFUHE2jLpkbTkQA7OLQVe4tRjJntA/exec', {
        method: 'POST',
        body: JSON.stringify({
          id_token: idToken,
          action: "log",
          start: new Date(startTime).toISOString(),
          stop: new Date(stopTime).toISOString(),
          duration,
          mode
        }),
        headers: { 'Content-Type': 'application/json' }
      });

      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    };
  </script>
</body>
</html>
