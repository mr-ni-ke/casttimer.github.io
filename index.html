<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      function handleCredentialResponse(response) {
        const id_token = response.credential;
        google.script.run
          .withSuccessHandler(function (userData) {
            if (!userData) {
              document.body.innerHTML = "<h2>Access Denied</h2>";
              return;
            }

            document.getElementById("name").value = userData.name;
            document.getElementById("lang").value = userData.language;
            document.querySelector(".container").style.display = "block";
            document.getElementById("auth").style.display = "none";

            initTimer(); // инициализация кнопок после авторизации
          })
          .verifyIdToken(id_token);
      }
    </script>
    <style>
      /* всё как было — без изменений */
    </style>
  </head>
  <body>
    <div id="auth">
      <div
        id="g_id_onload"
        data-client_id="619365294529-aq28ud62bftedigk08olqfdsfmjaae32.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-callback="handleCredentialResponse"
        data-auto_prompt="true"
      ></div>
      <div class="g_id_signin" data-type="standard" data-size="large"></div>
    </div>

    <div class="container" style="display:none;">
      <label>Welcome,</label>
      <input type="text" id="name" readonly />
      <input type="text" id="lang" readonly hidden />

      <label>You are MC or CC today?</label>
      <select id="modeSelect">
        <option value="MC">MC</option>
        <option value="CC">CC</option>
      </select>

      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>

      <p id="timer">00:00:00</p>
      <p id="savedTime"></p>

      <button id="toggleThemeBtn">Switch to Dark</button>
    </div>

    <script>
      const body = document.body;
      const toggleThemeBtn = document.getElementById("toggleThemeBtn");

      function setTheme(theme) {
        if (theme === "dark") {
          body.classList.add("dark");
          toggleThemeBtn.textContent = "L";
        } else {
          body.classList.remove("dark");
          toggleThemeBtn.textContent = "D";
        }
        localStorage.setItem("theme", theme);
      }

      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        setTheme(savedTheme);
      } else {
        setTheme("light");
      }

      toggleThemeBtn.addEventListener("click", () => {
        if (body.classList.contains("dark")) {
          setTheme("light");
        } else {
          setTheme("dark");
        }
      });

      function formatTime(ms) {
        const totalSec = Math.floor(ms / 1000);
        const hrs = String(Math.floor(totalSec / 3600)).padStart(2, "0");
        const mins = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
        const secs = String(totalSec % 60).padStart(2, "0");
        return `${hrs}:${mins}:${secs}`;
      }

      function initTimer() {
        const timerEl = document.getElementById("timer");
        const savedTimeEl = document.getElementById("savedTime");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        let startTime = null;
        let interval = null;

        startBtn.onclick = () => {
          startTime = new Date();
          startBtn.disabled = true;
          stopBtn.disabled = false;
          savedTimeEl.textContent = "";
          timerEl.classList.add("active");

          interval = setInterval(() => {
            const now = new Date();
            const elapsed = now.getTime() - startTime.getTime();
            timerEl.textContent = formatTime(elapsed);
          }, 1000);
        };

        stopBtn.onclick = () => {
          if (!startTime) return;

          clearInterval(interval);

          const stopTime = new Date();
          const durationMs = stopTime.getTime() - startTime.getTime();
          const durationSec = (durationMs / 1000).toFixed(2);

          const name = document.getElementById("name").value;
          const language = document.getElementById("lang").value;
          const mode = document.getElementById("modeSelect").value;

          const startStr = startTime.toISOString();
          const stopStr = stopTime.toISOString();

          google.script.run.saveTime(
            startStr,
            stopStr,
            language,
            name,
            parseFloat(durationSec),
            mode
          );

          startBtn.disabled = false;
          stopBtn.disabled = true;
          timerEl.textContent = "00:00:00";
          timerEl.classList.remove("active");
          savedTimeEl.textContent = `Saved time: ${formatTime(durationMs)}`;
          startTime = null;
        };
      }
    </script>
  </body>
</html>
